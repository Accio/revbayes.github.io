<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="search-domain" value="https://revbayes.github.io/revbayes-site/">
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    <link rel="stylesheet" href="/revbayes-site/assets/css/syntax.css">
    <link rel="stylesheet" type="text/css" href="/revbayes-site/assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="/revbayes-site/assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="/revbayes-site/assets/css/main.css" />
    <title>RevBayes: Episodic Diversification Rate Estimation</title>
  </head>
  <body>
    <div class="container">
      <nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <a href="/revbayes-site/" class="pull-left">
        <img class="navbar-logo" src="/revbayes-site/assets/img/aquabayes-desaturated.png" alt="RevBayes Logo" />
      </a>
      
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar" align="right"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="/revbayes-site/software/">Software</a></li>
        <li><a href="/revbayes-site/tutorials/">Tutorials</a></li>
        <li><a href="/revbayes-site/workshops/">Workshops</a></li>
        <li><a href="/revbayes-site/developer/">Developer</a></li>
      </ul>
      <!-- <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form> -->
    </div>
  </div>
</nav>

      <div class="row">
	<h1 class="maintitle">Episodic Diversification Rate Estimation</h1>
	<h3 class="subtitle">Estimating episodic, tree-wide changes in diversification rates</h3>
	<h4 class="maintitle">Sebastian H&#246;hna</h4>
</div>


<blockquote class="overview no-print" id="overview">
  <h2>Overview</h2>
  
  <div class="row">
    <div class="col-md-9">
        <strong>Prerequisites</strong>
        
          <ul id="prerequisites">
          
            <li><a href="/revbayes-site/tutorials/intro/">Rev Language Syntax</a></li>
          
          </ul>
        
    </div>
  </div>
  
</blockquote>



<h1 id="sec:diversification_rate_overview">Overview: Diversification Rate Estimation</h1>

<p>Models of speciation and extinction are fundamental to any phylogenetic
analysis of macroevolutionary processes
(<em>e.g.,</em>divergence time estimation,
diversification rate estimation, continuous and discrete trait
evolution, and historical biogeography). First, a prior model describing
the distribution of speciation events over time is critical to
estimating phylogenies with branch lengths proportional to time. Second,
stochastic branching models allow for inference of speciation and
extinction rates. These inferences allow us to investigate key questions
in evolutionary biology.</p>

<p>Diversification-rate parameters may be included as nuisance parameters
of other phylogenetic models—<em>i.e.,</em>where
these diversification-rate parameters are not of direct interest. For
example, many methods for estimating species divergence times—such as
<code class="highlighter-rouge">BEAST</code><a href="#Drummond2012">(Drummond et al. 2012)</a>,
<code class="highlighter-rouge">MrBayes</code><a href="#Ronquist2012">(Ronquist et al. 2012)</a>, and <code class="highlighter-rouge">RevBayes</code>
<a href="#Hoehna2016b">(Höhna et al. 2016)</a>—implement ‘relaxed-clock models’ that include a
constant-rate birth-death branching process as a prior model on the
distribution of tree topologies and node ages. Although the parameters
of these ‘tree priors’ are not typically of direct interest, they are
nevertheless estimated as part of the joint posterior probability
distribution of the relaxed-clock model, and so can be estimated simply
by querying the corresponding marginal posterior probability densities.
In fact, this may provide more robust estimates of the
diversification-rate parameters, as they accommodate uncertainty in the
other phylogenetic-model parameters (including the tree topology,
divergence-time estimates, and the other relaxed-clock model
parameters). More recent work,
<em>e.g.,</em><a href="#Heath2014">(Heath et al. 2014)</a>, uses macroevolutionary
models (the fossilized birth-death process) to calibrate phylogenies and
thus to infer dated trees.</p>

<p>In these tutorials we focus on the different types of macroevolutionary
models to study diversification processes and thus the
diversification-rate parameters themselves. Nevertheless, these
macroevolutionary models should be used for other evolutionary
questions, when an appropriate prior distribution on the tree and
divergence times is needed.</p>

<h2 id="types-of-hypotheses-for-estimating-diversification-rates">Types of Hypotheses for Estimating Diversification Rates</h2>

<p>Many evolutionary phenomena entail differential rates of diversification
(speciation – extinction); <em>e.g.,</em>adaptive
radiation, diversity-dependent diversification, key innovations, and
mass extinction. The specific study questions regarding lineage
diversification may be classified within three fundamental categories of
inference problems. Admittedly, this classification scheme is somewhat
arbitrary, but it is nevertheless useful, as it allows users to navigate
the ever-increasing number of available phylogenetic methods. Below, we
describe each of the fundamental questions regarding diversification
rates.</p>

<h4 id="1-diversification-rate-through-time-estimation">(1) Diversification-rate through time estimation</h4>

<p><em>What is the (constant) rate of diversification in my study group?</em> The
most basic models estimate parameters of the stochastic-branching
process (<em>i.e.,</em>rates of speciation and
extinction, or composite parameters such as net-diversification and
relative-extinction rates) under the assumption that rates have remained
constant across lineages and through time;
<em>i.e.,</em>under a constant-rate birth-death
stochastic-branching process model <a href="#Nee1994b">(Nee et al. 1994)</a>. Extensions to the
(basic) constant-rate models include diversification-rate variation
through time (missing reference). First, we might ask whether
there is evidence of an episodic, tree-wide increase in diversification
rates (associated with a sudden increase in speciation rate and/or
decrease in extinction rate), as might occur during an episode of
adaptive radiation. A second question asks whether there is evidence of
a continuous/gradual decrease in diversification rates through time
(associated with decreasing speciation rates and/or increasing
extinction rates), as might occur because of diversity-dependent
diversification (<em>i.e.,</em>where competitive
ecological interactions among the species of a growing tree decrease the
opportunities for speciation and/or increase the probability of
extinction, <em>e.g.,</em><a href="#Hoehna2014a">(Höhna 2014)</a>). Third, we
can ask whether changes in diversification rates are correlated with
environmental factors, such as environmental CO~2~ or temperature
<a href="#Condamine2013">(Condamine et al. 2013)</a>. A final question in this category asks whether our
study tree was impacted by a mass-extinction event (where a large
fraction of the standing species diversity is suddenly lost,
<em>e.g.,</em><a href="#May2016">(May et al. 2016)</a>). The common theme of these
studies is that the diversification process is tree-wide, that is, all
lineages of the study group have the exact same rates at a given time.</p>

<h4 id="2-diversification-rate-variation-across-branches-estimation">(2) Diversification-rate variation across branches estimation</h4>

<p><em>Is there evidence that diversification rates have varied significantly
across the branches of my study group?</em> Models have been developed to
detect departures from rate constancy across lineages; these tests are
analogous to methods that test for departures from a molecular
clock—<em>i.e.,</em>to assess whether substitution
rates vary significantly across lineages (missing reference).
These models are important for assessing whether a given tree violates
the assumptions of rate homogeneity among lineages. Furthermore, these
models are important to answer questions such as: <em>What are the
branch-specific diversification rates?</em>; and <em>Have there been
significant diversification-rate shifts along branches in my study
group, and if so, how many shifts, what magnitude of rate-shifts and
along which branches?</em></p>

<h4 id="3-character-dependent-diversification-rate-estimation">(3) Character-dependent diversification-rate estimation</h4>

<p><em>Are diversification rates correlated with some variable in my study
group?</em> Character-dependent diversification-rate models aim to identify
overall correlations between diversification rates and organismal
features (binary and multi-state discrete morphological traits,
continuous morphological traits, geographic range, etc.). For example,
one can hypothesize that a binary character, say if an organism is
herbivorous/carnivorous or self-compatible/self-incompatible, impact the
diversification rates. Then, if the organism is in state 0
(<em>e.g.,</em>is herbivorous) it has a lower (or
higher) diversification rate than if the organism is in state 1
(<em>e.g.,</em>carnivorous) <a href="#Maddison2007">(Maddison et al. 2007)</a>.</p>

<h1 id="sec:models">Diversification Rate Models</h1>

<p>We begin this section with a general introduction to the stochastic
birth-death branching process that underlies inference of
diversification rates in <code class="highlighter-rouge">RevBayes</code>. This primer will provide some
details on the relevant theory of stochastic-branching process models.
We appreciate that some readers may want to skip this somewhat technical
primer; however, we believe that a better understanding of the relevant
theory provides a foundation for performing better inferences. We then
discuss a variety of specific birth-death models, but emphasize that
these examples represent only a tiny fraction of the possible
diversification-rate models that can be specified in <code class="highlighter-rouge">RevBayes</code>.</p>

<h2 id="the-birth-death-branching-process">The birth-death branching process</h2>

<p>Our approach is based on the <em>reconstructed evolutionary process</em>
described by <a href="#Nee1994b">(Nee et al. 1994)</a>; a birth-death process in which only sampled,
extant lineages are observed. Let $N(t)$ denote the number of species at
time $t$. Assume the process starts at time $t_1$ (the ‘crown’ age of
the most recent common ancestor of the study group, $t_\text{MRCA}$)
when there are two species. Thus, the process is initiated with two
species, $N(t_1) = 2$. We condition the process on sampling at least one
descendant from each of these initial two lineages; otherwise $t_1$
would not correspond to the $t_\text{MRCA}$ of our study group. Each
lineage evolves independently of all other lineages, giving rise to
exactly one new lineage with rate $b(t)$ and losing one existing lineage
with rate $d(t)$ (Figure [fig:BirthDeathShift] and
Figure [fig:BDP]). Note that although each lineage evolves
independently, all lineages share both a common (tree-wide) speciation
rate $b(t)$ and a common extinction rate $d(t)$
(missing reference). Additionally, at certain times,
$t_{\mathbb{M}}$, a mass-extinction event occurs and each species
existing at that time has the same probability, $\rho$, of survival.
Finally, all extinct lineages are pruned and only the reconstructed tree
remains (Figure [fig:BirthDeathShift]).</p>

<p>![A realization of the birth-death process with mass extinction.
Lineages that have no extant or sampled descendant are shown in gray and
surviving lineages are shown in a thicker black line.<span data-label="fig:BirthDeathShift">](\ResourcePath figures/BirthDeathShift.pdf){width=”80.00000%”}</span></p>

<blockquote class="figure">
  <p><img src="figures/BirthDeathShift.png" alt="" /> 
A realization of the
birth-death process with mass extinction. Lineages that have no extant
or sampled descendant are shown in gray and surviving lineages are shown
in a thicker black line.</p>
</blockquote>

<p>![ The process is initiated at the first speciation event (the
‘crown-age’ of the MRCA) when there are two initial lineages. At each
speciation event the ancestral lineage is replaced by two descendant
lineages. At an extinction event one lineage simply terminates. (A) A
complete tree including extinct lineages. (B) The reconstructed tree of
tree from A with extinct lineages pruned away. (C) A <em>uniform</em> subsample
of the tree from B, where each species was sampled with equal
probability, $\rho$. (D) A <em>diversified</em> subsample of the tree from B,
where the species were selected so as to maximize diversity.<span data-label="fig:BDP">](\ResourcePath figures/birth-death-sketch.pdf){width=”\textwidth”}</span></p>

<blockquote class="figure">
  <p><img src="figures/birth-death-sketch.png" alt="" /> 
<strong>Examples of
trees produced under a birth-death process.</strong> The process is
initiated at the first speciation event (the ‘crown-age’ of the MRCA)
when there are two initial lineages. At each speciation event the
ancestral lineage is replaced by two descendant lineages. At an
extinction event one lineage simply terminates. (A) A complete tree
including extinct lineages. (B) The reconstructed tree of tree from A
with extinct lineages pruned away. (C) A <em>uniform</em> subsample of the tree
from B, where each species was sampled with equal probability, $\rho$.
(D) A <em>diversified</em> subsample of the tree from B, where the species were
selected so as to maximize diversity.</p>
</blockquote>

<p>To condition the probability of observing the branching times on the
survival of both lineages that descend from the root, we divide by
$P(N(T) &gt; 0 | N(0) = 1)^2$. Then, the probability density of the
branching times, $\mathbb{T}$, becomes <script type="math/tex">\begin{aligned}
P(\mathbb{T}) = \fra\frac{}{b}ace{P(N(T) = 1 \mid N(0) = 1)^2}^{\text{both initial lineages have one descendant}}}{ \underbrace{P(N(T) > 0 \mid N(0) = 1)^2}_{\text{both initial lineages survive}} } \times \prod_{i=2}^{n-1\frac{ }{b}ace{i \times b(t_i)}^{\text{speciation rate}} \time\frac{ }{b}ace{P(N(T) = 1 \mid N(t_i) = 1)}^\text{lineage has one descendant},\end{aligned}</script>
and the probability density of the reconstructed tree (topology and
branching times) is then <script type="math/tex">% <![CDATA[
\begin{aligned}
P(\Psi) = \; & \frac{2^{n-1}}{n!(n-1)!} \times \left( \frac{P(N(T) = 1 \mid N(0) = 1)}{P(N(T) > 0 \mid N(0) = 1)} \right)^2 \nonumber\\
		  \; & \times \prod_{i=2}^{n-1} i \times b(t_i) \times P(N(T) = 1 \mid N(t_i) = 1)
	\label{eq:tree_probability}\end{aligned} %]]></script></p>

<p>We can expand Equation ([eq:tree_probability]) by substituting
$P(N(T) &gt; 0 \mid N(t) =1)^2 \exp(r(t,T))$ for
$P(N(T) = 1 \mid N(t) = 1)$, where $r(u,v) = \int^v_u d(t)-b(t)dt$; the
above equation becomes <script type="math/tex">% <![CDATA[
\begin{aligned}
P(\Psi) = \; & \frac{2^{n-1}}{n!(n-1)!} \times \left( \frac{P(N(T) > 0 \mid N(0) =1 )^2 \exp(r(0,T))}{P(N(T) > 0 \mid N(0) = 1)} \right)^2 \nonumber\\
		  \; & \times \prod_{i=2}^{n-1} i \times b(t_i) \times P(N(T) > 0 \mid N(t_i) = 1)^2 \exp(r(t_i,T)) \nonumber\\
		= \; & \frac{2^{n-1}}{n!} \times \Big(P(N(T) > 0 \mid N(0) =1 ) \exp(r(0,T))\Big)^2 \nonumber\\
		  \; & \times \prod_{i=2}^{n-1} b(t_i) \times P(N(T) > 0 \mid N(t_i) = 1)^2 \exp(r(t_i,T)).
		\label{eq:tree_probability_substitution}\end{aligned} %]]></script> For a detailed
description of this substitution, see <a href="#Hoehna2015a">(Höhna 2015)</a>. Additional
information regarding the underlying birth-death process can be found in
@Thompson1975 [Equation 3.4.6] and <a href="#Nee1994b">(Nee et al. 1994)</a> for constant rates and
(missing reference) for arbitrary rate functions.</p>

<p>To compute the equation above we need to know the rate function,
$r(t,s) = \int_t^s d(x)-b(x) dx$, and the probability of survival,
$P(N(T)!&gt;!0|N(t)!=!1)$. <a href="#Yule1925">(Yule 1925)</a> and later <a href="#Kendall1948">(Kendall 1948)</a> derived
the probability that a process survives ($N(T) &gt; 0$) and the probability
of obtaining exactly $n$ species at time $T$ ($N(T) = n$) when the
process started at time $t$ with one species. Kendall’s results were
summarized in Equation (3) and Equation (24) in <a href="#Nee1994b">(Nee et al. 1994)</a>
<script type="math/tex">% <![CDATA[
\begin{aligned}
P(N(T)\!>\!0|N(t)\!=\!1) & = & \left(1+\int\limits_t^{T} \bigg(\mu(s) \exp(r(t,s))\bigg) ds\right)^{-1} \label{eq:survival} \\ \nonumber \\
P(N(T)\!=\!n|N(t)\!=\!1) & = & (1-P(N(T)\!>\!0|N(t)\!=\!1)\exp(r(t,T)))^{n-1} \nonumber\\
& & \times P(N(T)\!>\!0|N(t)\!=\!1)^2 \exp(r(t,T)) \label{eq:N} %]]></script> An
overview for different diversification models is given in
<a href="#Hoehna2015a">(Höhna 2015)</a>.</p>

<p><strong><em>Sidebar: Phylogenetic trees as observations</em></strong></p>

<p>The branching processes used here describe probability distributions on
phylogenetic trees. This probability distribution can be used to infer
diversification rates given an “observed” phylogenetic tree. In reality
we never observe a phylogenetic tree itself. Instead, phylogenetic trees
themselves are estimated from actual observations, such as DNA
sequences. These phylogenetic tree estimates, especially the divergence
times, can have considerable uncertainty associated with them. Thus, the
correct approach for estimating diversification rates is to include the
uncertainty in the phylogeny by, for example, jointly estimating the
phylogeny and diversification rates. For the simplicity of the following
tutorials, we take a shortcut and assume that we know the phylogeny
without error. For publication quality analysis you should always
estimate the diversification rates jointly with the phylogeny and
divergence times.</p>

<h1 id="estimating-speciation--extinction-rates-through-time">Estimating Speciation &amp; Extinction Rates Through Time</h1>

<h2 id="outline">Outline</h2>

<p>This tutorial describes how to specify an episodic branching-process
model in <code class="highlighter-rouge">RevBayes</code>; a birth-death process where diversification rates
vary episodically through time modeled as piecewise-constant rates
(missing reference). The probabilistic graphical model is given
once at the beginning of this tutorial. Your goal is to estimate
speciation and extinction rates through-time using Markov chain Monte
Carlo (MCMC).</p>

<h2 id="requirements">Requirements</h2>

<p>We assume that you have read and hopefully completed the following
tutorials:</p>

<ul>
  <li>
    <p><a href="https://github.com/revbayes/revbayes_tutorial/raw/master/tutorial_TeX/RB_Getting_Started/RB_Getting_Started.pdf">Getting
started</a></p>
  </li>
  <li>
    <p><a href="https://github.com/revbayes/revbayes_tutorial/raw/master/tutorial_TeX/RB_Intro_Tutorial/RB_Intro_Tutorial.pdf">Very Basic Introduction to
<code class="highlighter-rouge">Rev</code></a></p>
  </li>
  <li>
    <p><a href="https://github.com/revbayes/revbayes_tutorial/raw/master/tutorial_TeX/RB_Rev_Tutorial/RB_Rev_Tutorial.pdf">General Introduction to the <code class="highlighter-rouge">Rev</code>
syntax</a></p>
  </li>
  <li>
    <p><a href="https://github.com/revbayes/revbayes_tutorial/raw/master/tutorial_TeX/RB_MCMC_Archery_Tutorial/RB_MCMC_Archery_Tutorial.pdf">General Introduction to MCMC using an archery
example</a></p>
  </li>
  <li>
    <p><a href="https://github.com/revbayes/revbayes_tutorial/raw/master/tutorial_TeX/RB_MCMC_Binomial_Tutorial/RB_MCMC_Binomial_Tutorial.pdf">General Introduction to MCMC using a coin-flipping
example</a></p>
  </li>
  <li>
    <p><a href="https://github.com/revbayes/revbayes_tutorial/raw/master/tutorial_TeX/RB_DiversificationRate_Tutorial/RB_DiversificationRate_Tutorial.pdf">Basic Diversification Rate
Estimation</a></p>
  </li>
</ul>

<p>Note that the <a href="https://github.com/revbayes/revbayes_tutorial/raw/master/tutorial_TeX/RB_Intro_Tutorial/RB_Intro_Tutorial.pdf"><code class="highlighter-rouge">Rev</code> basics
tutorial</a>
introduces the basic syntax of <code class="highlighter-rouge">Rev</code> but does not cover any phylogenetic
models. We tried to keep this tutorial very basic and introduce all the
language concepts and theory on the way. You may only need the <a href="https://github.com/revbayes/revbayes_tutorial/raw/master/tutorial_TeX/RB_Rev_Tutorial/RB_Rev_Tutorial.pdf"><code class="highlighter-rouge">Rev</code>
syntax
tutorial</a>
for a more in-depth discussion of concepts in <code class="highlighter-rouge">Rev</code>.</p>

<h1 id="data-and-files">Data and files</h1>

<p>We provide the data file(s) which we will use in this tutorial. You may
want to use your own data instead. In the ‘data‘ folder, you will find
the following files</p>

<ul>
  <li>‘primates_tree.nex‘: Dated primates phylogeny including 233 out of
367 species from <a href="#MagnusonFord2012">(Magnuson-Ford and Otto 2012)</a>.</li>
</ul>

<p>Open the tree ‘data/primates_tree.nex‘ in
<code class="highlighter-rouge">FigTree</code>.</p>

<h1 id="episodic-birth-death-model">Episodic Birth-Death Model</h1>

<p>The basic idea behind the model is that speciation and extinction rates
are constant within time intervals but can be different between time
intervals. Thus, we will divide time into equally sized intervals, with
the only exception that the first 20% of the time does not have any rate
changes. Our only reason to do so is because there are too few lineages
in the reconstructed tree at that time to obtain reliable parameter
estimates. An overview of the underlying theory of the specific model
and implementation is given in <a href="#Hoehna2015a">(Höhna 2015)</a>.</p>

<blockquote class="figure">
  <p><img src="figures/EBD_scenarios.png" alt="" /> 
Two scenarios of
birth-death models. On the left we show constant diversification. On the
right we show an example of an episodic birth-death process where rates
are constant in each time interval (epoch). The top panel of this figure
shows an example realization under the given rates.</p>
</blockquote>

<p>Figure [fig:EBD] shows an example of a constant rate birth-death
process and an episodic birth-death process.</p>

<p>We assume that the log-transformed rates are drawn from a normal
distribution. Furthermore, we will assume that rates are autocorrelated,
that is, rates in the current time interval will be centered around the
rates in the previous time interval. Thus, we model (log-transformed)
diversification rates by a Brownian motion. The assumption of
autocorrelated rates does not only makes sense biologically but also
improves our ability to estimate parameters.</p>

<blockquote class="figure">
  <p><img src="figures/graphical_model_EBD.png" alt="" /> 
A graphical model
with the outline of the <code class="highlighter-rouge">Rev</code> code. On the left we see the graphical
model describing the correlated (Brownian motion) model for
rate-variation through time. On the right we show the corresponding
<code class="highlighter-rouge">Rev</code> commands to instantiate this model. This figure gives a complete
overview of the model that we use here in this analysis.</p>
</blockquote>

<p>We show a graphical model of the episodic birth-death process with
autocorrelated rates in Figure [fig:EBD_GM]. This graphical model
shows you which variables are included in the model, and the dependency
between the variables. Thus, it makes the structure and assumption of
the model clear and visible instead of a black-box <a href="#Hoehna2014b">(Höhna et al. 2014)</a>. For
example, you see how the speciation and extinction rates in each time
interval depend on the rates of the previous interval, and that we use a
hyperprior for the standard deviation of rates between time intervals.</p>

<h2 id="read-the-tree">Read the tree</h2>

<p>Begin by reading in the “observed” tree.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>T &lt;- readTrees("data/primates_tree.nex")[1]
</code></pre></div></div>

<p>From this tree, we get some helpful variables, such as the taxon
information which we need to instantiate the birth-death process.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>taxa &lt;- T.taxa()
</code></pre></div></div>

<p>Additionally, we initialize an iterator variable for our vector of moves
and monitors.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvi = 0
mni = 0
</code></pre></div></div>

<p>Finally, we create a helper variable that specifies the number of
intervals.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NUM_INTERVALS = 10
</code></pre></div></div>

<p>Using this variable we can easily change our script to break-up time
into many (<em>e.g.,</em> ‘NUM_INTERVALS = 100‘) or
few (<em>e.g.,</em> ‘NUM_INTERVALS = 4‘) intervals.</p>

<h2 id="specifying-the-model">Specifying the model</h2>

<h3 id="priors-on-amount-of-rate-variation">Priors on amount of rate variation</h3>

<p>We start by specifying prior distributions on the rates. Each
interval-specific speciation- and extinction-rate will be drawn from a
normal distribution. Thus, we need a parameter for the standard
deviation of those normal distributions. We use an exponential
hyperprior with rate 1.0 to estimate the standard deviation, but assume
that all speciation rates and all extinction rates share the same
standard deviation. The motivation for an exponential hyperprior is that
it has the highest probability density at 0 which would make the
variance of rates between consecutive time intervals 0 and thus
represent a constant-rate process. The data will tell us if there should
be much variation in rates through time. (You may want to experiment
with this hyperprior if you are interested.)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>speciation_sd ~ dnExponential(1.0)
extinction_sd ~ dnExponential(1.0)
</code></pre></div></div>

<p>We apply a simple scaling move on each prior parameter.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves[++mvi] = mvScale(speciation_sd,weight=5.0)
moves[++mvi] = mvScale(extinction_sd,weight=5.0)
</code></pre></div></div>

<h3 id="specifying-episodic-rates">Specifying episodic rates</h3>

<p>As we mentioned before, we will apply normal distributions as priors for
each log-transformed rate. We begin with the rate at the present which
is our initial rate parameter. The rates at the present will be
specified slightly differently because they are not correlated to any
previous rates. This is because we are actually modeling rate-changes
backwards in time and there is no previous rate for the rate at the
present. Modeling rates backwards in time makes it easier for us if we
had some prior information about some event affected diversification
sometime before the present, <em>e.g.,</em>25 million
years ago.</p>

<p>We use a uniform distribution between -10 and 10 because of our lack of
prior knowledge on the diversification rate. This actually means that we
allow speciation and extinction rates between $e^{-10}$ and $e^10$, so
we should clearly cover the true values. (Note that for diversification
rate estimates, $e^{-10}$ is virtually 0 since the rate is so slow).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>log_speciation[1] ~ dnUniform(-10.0,10.0)
log_speciation[1] ~ dnUniform(-10.0,10.0)
</code></pre></div></div>

<p>Notice that we store the diversification rate variables in vectors.
Storing the rate parameters in vectors will be useful and important
later when we pass the rates into the birth-death process.</p>

<p>We apply simple sliding window moves for the rates. Normally we would
use scaling moves but in this case we work on the log-transformed
parameters and thus sliding moves perform better. (If you are keen you
can test the differences.)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves[++mvi] = mvSlide(log_speciation[1], weight=2)
moves[++mvi] = mvSlide(log_extinction[1], weight=2)
</code></pre></div></div>

<p>Now we transform the diversification rate parameters into actual rates
using an exponential parameter transformation.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>speciation[1] := exp( log_speciation[1] )
extinction[1] := exp( log_extinction[1] )
</code></pre></div></div>

<p>Next, we specify the speciation and extinction rates for each time
interval (<em>i.e.,</em>epoch). This can be done
efficiently using a ‘for‘-loop. We will use a specific index variable so
that we can more easily refer to the rate at the previous interval.
Remember that we want to model the rates as a Brownian motion, which we
achieve by specifying a normal distribution as the prior distribution on
the rates centered around the previous rate
(<em>i.e.,</em>the mean of the normal distribution is
equal to the previous rate).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for (i in 1:NUM_INTERVALS) {
    index = i+1

    log_speciation[index] ~ dnNormal( mean=log_speciation[i], sd=speciation_sd )
    log_extinction[index] ~ dnNormal( mean=log_extinction[i], sd=extinction_sd )

    moves[++mvi] = mvSlide(log_speciation[index], weight=2)
    moves[++mvi] = mvSlide(log_extinction[index], weight=2)

    speciation[index] := exp( log_speciation[index] )
    extinction[index] := exp( log_extinction[index] )

}
</code></pre></div></div>

<p>Finally, we apply moves that slide all values in the rate vectors,
<em>i.e.,</em>all speciation or extinction rates. We
will use an ‘mvVectorSlide‘ move.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves[++mvi] = mvVectorSlide(log_speciation, weight=10)
moves[++mvi] = mvVectorSlide(log_extinction, weight=10)
</code></pre></div></div>

<p>Additionally, we apply a ‘mvShrinkExpand‘ move which changes the spread
of several variables around their mean.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moves[++mvi] = mvShrinkExpand( log_speciation, sd=speciation_sd, weight=10 )
moves[++mvi] = mvShrinkExpand( log_extinction, sd=extinction_sd, weight=10 )
</code></pre></div></div>

<p>Both moves considerably improve the efficiency of our MCMC analysis.</p>

<h3 id="setting-up-the-time-intervals">Setting up the time intervals</h3>

<p>In <code class="highlighter-rouge">RevBayes</code> you actually have the possibility to specify unequal time
intervals or even different intervals for the speciation and extinction
rate. This is achieved by providing a vector of times when each interval
ends. Here we simply break-up the most recent 80% of time since the root
in equal-length intervals.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>interval_times &lt;- T.rootAge() * (1:NUM_INTERVALS) / (NUM_INTERVALS) * 0.8
</code></pre></div></div>

<p>This vector of times will be used for both the speciation and extinction
rates. Also, remember that the times of the intervals represent ages
going backwards in time.</p>

<h3 id="incomplete-taxon-sampling">Incomplete Taxon Sampling</h3>

<p>We know that we have sampled 233 out of 367 living primate species. To
account for this we can set the sampling parameter as a constant node
with a value of 233/367. For simplicity, and since almost all species
have been sampled, we assume <em>uniform</em> taxon sampling
(missing reference),</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rho &lt;- T.ntips()/367
</code></pre></div></div>

<h3 id="root-age">Root age</h3>

<p>The birth-death process requires a parameter for the root age. In this
exercise we use a fixed tree and thus we know the age of the tree.
Hence, we can get the value for the root from the @MagnusonFord2012
tree.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root_time &lt;- T.rootAge()
</code></pre></div></div>

<h3 id="the-time-tree">The time tree</h3>

<p>Now we have all of the parameters we need to specify the full episodic
birth-death model. We initialize the stochastic node representing the
time tree.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>timetree ~ dnEpisodicBirthDeath(rootAge=T.rootAge(), lambdaRates=speciation, lambdaTimes=interval_times, muRates=extinction, muTimes=interval_times, rho=rho, samplingStrategy="uniform", condition="survival", taxa=taxa)
</code></pre></div></div>

<p>You may notice that we explicitly specify that we want to condition on
survival. It is possible to change this condition to the <em>time of the
process</em> or <em>the number of sampled taxa</em> too.</p>

<p>Then we attach data to the ‘timetree‘ variable.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>timetree.clamp(T)
</code></pre></div></div>

<p>Finally, we create a workspace object of our whole model using the
‘model()‘ function.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymodel = model(speciation)
</code></pre></div></div>

<p>The ‘model()‘ function traversed all of the connections and found all of
the nodes we specified.</p>

<h2 id="running-an-mcmc-analysis">Running an MCMC analysis</h2>

<h3 id="specifying-monitors">Specifying Monitors</h3>

<p>For our MCMC analysis, we need to set up a vector of <em>monitors</em> to
record the states of our Markov chain. First, we will initialize the
model monitor using the ‘mnModel‘ function. This creates a new monitor
variable that will output the states for all model parameters when
passed into a MCMC function.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitors[++mni] = mnModel(filename="output/primates_EBD.log",printgen=10, separator = TAB)
</code></pre></div></div>

<p>Additionally, we create four separate file monitors, one for each vector
of speciation and extinction rates and for each speciation and
extinction rate epoch (<em>i.e.,</em>the times when
the interval ends). We want to have the speciation and extinction rates
stored separately so that we can plot them nicely afterwards.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitors[++mni] = mnFile(filename="output/primates_EBD_speciation_rates.log",printgen=10, separator = TAB, speciation)
monitors[++mni] = mnFile(filename="output/primates_EBD_speciation_times.log",printgen=10, separator = TAB, interval_times)
monitors[++mni] = mnFile(filename="output/primates_EBD_extinction_rates.log",printgen=10, separator = TAB, extinction)
monitors[++mni] = mnFile(filename="output/primates_EBD_extinction_times.log",printgen=10, separator = TAB, interval_times)
</code></pre></div></div>

<p>Finally, we create a screen monitor that will report the states of
specified variables to the screen with ‘mnScreen‘:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitors[++mni] = mnScreen(printgen=1000, extinction_sd, speciation_sd)
</code></pre></div></div>

<h3 id="initializing-and-running-the-mcmc-simulation">Initializing and Running the MCMC Simulation</h3>

<p>With a fully specified model, a set of monitors, and a set of moves, we
can now set up the MCMC algorithm that will sample parameter values in
proportion to their posterior probability. The ‘mcmc()‘ function will
create our MCMC object:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymcmc = mcmc(mymodel, monitors, moves)
</code></pre></div></div>

<p>First, we will run a pre-burnin to tune the moves and to obtain starting
values from the posterior distribution.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymcmc.burnin(generations=10000,tuningInterval=200)
</code></pre></div></div>

<p>Now, run the MCMC:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mymcmc.run(generations=50000)
</code></pre></div></div>

<p>When the analysis is complete, you will have the monitored files in your
output directory. You can then visualize the rates through time using
<code class="highlighter-rouge">R</code>using our package <code class="highlighter-rouge">Rev</code>Gadgets. If you don’t have the
R-package <code class="highlighter-rouge">Rev</code>Gadgets installed, or if you have trouble with the
package, then please read the separate tutorial about the package.</p>

<p>Just start <code class="highlighter-rouge">R</code>in the main directory for this analysis and
then type the following commands:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>library(RevGadgets)

tree &lt;- read.nexus("data/primates_tree.nex")

rev_out &lt;- rev.process.div.rates(speciation_times_file = "output/primates_EBD_speciation_times.log", speciation_rates_file = "output/primates_EBD_speciation_rates.log", extinction_times_file = "output/primates_EBD_extinction_times.log", extinction_rates_file = "output/primates_EBD_extinction_rates.log", tree, burnin=0.25,numIntervals=100)

pdf("EBD.pdf")
par(mfrow=c(2,2))
rev.plot.output(rev_out,use.geoscale=FALSE)
dev.off()
</code></pre></div></div>

<p>(Note, you may want to add a nice geological timescale to the plot by
setting ‘use.geoscale=TRUE‘ but then you can only plot one figure per
page.)</p>

<p>The <code class="highlighter-rouge">Rev</code> file for performing this analysis:
<a href="https://github.com/revbayes/revbayes_tutorial/raw/master/RB_DiversificationRate_Episodic_Tutorial/scripts/mcmc_EBD.Rev">‘mcmc_EBD.Rev‘</a>.</p>

<blockquote class="figure">
  <p><img src="figures/EBD_10_Result.png" alt="" /> 
Resulting
diversification rate estimations when using 10 intervals. You should
obtain similar results when you use 10 intervals. The estimated rates
might change when you use a different resolution,
<em>i.e.,</em>a different number of intervals.</p>
</blockquote>

<h2 id="exercise-1">Exercise 1</h2>

<ul>
  <li>
    <p>Run an MCMC simulation to estimate the posterior distribution of the
speciation rate and extinction rate.</p>
  </li>
  <li>
    <p>Visualize the rate through time using <code class="highlighter-rouge">R</code>.</p>
  </li>
  <li>
    <p>Do you see evidence for rate decreases or increases? What is the
general trend?</p>
  </li>
  <li>
    <p>Is there evidence for rate variation? Look at the estimates of
‘speciation_sd‘ and ‘extinction_sd‘: Is there information in the
data to change the estimates from the prior?</p>
  </li>
  <li>
    <p>Run the analysis using a different number of intervals,
<em>e.g.,</em>5 or 50. How do the rates change?</p>
  </li>
</ul>

<h2 id="exercise-2">Exercise 2</h2>

<ul>
  <li>
    <p>In our results we see that the extinction rate is fairly constant.
Modify the model by using a constant-rate for the extinction rate
parameter but still let the speciation rate vary through time.</p>

    <ul>
      <li>
        <p>Remove all previous occurrences of the extinction rates
(<em>i.e.,</em>priors, parameters and moves).</p>
      </li>
      <li>
        <p>Specify a lognormal prior distribution on the constant
extinction rate\
(‘extinction $\sim$ dnLognormal(-5,sd=2*0.587405)‘)</p>
      </li>
      <li>
        <p>Add a move for the new extinction rate parameter\
‘moves[++mvi] = mvScale(extinction,weight=5.0)‘.</p>
      </li>
      <li>
        <p>Remove the argument ‘muTimes=interval_times‘ from the
birth-death process.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>How does this influence your estimated rates?</p>
  </li>
</ul>

<p>Version dated:</p>

<ol class="bibliography"><li><span id="Drummond2012">Drummond A.J., Suchard M.A., Xie D., Rambaut A. 2012. Bayesian phylogenetics with BEAUti and the BEAST 1.7. Molecular Biology and Evolution. 29:1969–1973.</span>

<a href="https://doi.org/10.1093/molbev/mss075">10.1093/molbev/mss075</a>

</li>
<li><span id="Ronquist2012">Ronquist F., Teslenko M., Mark P. van der, Ayres D.L., Darling A., Höhna S., Larget B., Liu L., Suchard M.A., Huelsenbeck J.P. 2012. MrBayes 3.2: efficient Bayesian phylogenetic inference and model choice across a large model space. Systematic Biology. 61:539–542.</span>

<a href="https://doi.org/10.1093/sysbio/sys029">10.1093/sysbio/sys029</a>

</li>
<li><span id="Hoehna2016b">Höhna S., Landis M.J., Heath T.A., Boussau B., Lartillot N., Moore B.R., Huelsenbeck J.P., Ronquist F. 2016. RevBayes: Bayesian Phylogenetic Inference Using Graphical Models and an Interactive Model-Specification Language. Systematic Biology. 65:726–736.</span>

<a href="https://doi.org/10.1093/sysbio/syw021">10.1093/sysbio/syw021</a>

</li>
<li><span id="Heath2014">Heath T.A., Huelsenbeck J.P., Stadler T. 2014. The fossilized birth-death process for coherent calibration of divergence-time estimates. Proceedings of the National Academy of Sciences. 111:E2957–E2966.</span>

<a href="https://doi.org/10.1073/pnas.1319091111">10.1073/pnas.1319091111</a>

</li>
<li><span id="Nee1994b">Nee S., May R.M., Harvey P.H. 1994. The Reconstructed Evolutionary Process. Philosophical Transactions: Biological Sciences. 344:305–311.</span>

<a href="https://doi.org/10.1098/rstb.1994.0068">10.1098/rstb.1994.0068</a>

</li>
<li><span id="Hoehna2014a">Höhna S. 2014. Likelihood Inference of Non-Constant Diversification Rates with Incomplete Taxon Sampling. PLoS One. 9:e84184.</span>

<a href="https://doi.org/10.1371/journal.pone.0084184">10.1371/journal.pone.0084184</a>

</li>
<li><span id="Condamine2013">Condamine F.L., Rolland J., Morlon H. 2013. Macroevolutionary perspectives to environmental change. Ecology Letters.</span>

<a href="https://doi.org/10.1111/ele.12062">10.1111/ele.12062</a>

</li>
<li><span id="May2016">May M.R., Höhna S., Moore B.R. 2016. A Bayesian Approach for Detecting the Impact of Mass-Extinction Events on Molecular Phylogenies When Rates of Lineage Diversification May Vary. Methods in Ecology and Evolution. 7:947–959.</span>

<a href="https://doi.org/10.1111/2041-210X.12563">10.1111/2041-210X.12563</a>

</li>
<li><span id="Maddison2007">Maddison W.P., Midford P.E., Otto S.P. 2007. Estimating a binary character’s effect on speciation and extinction. Systematic Biology. 56:701.</span>

<a href="https://doi.org/10.1080/10635150701607033">10.1080/10635150701607033</a>

</li>
<li><span id="Hoehna2015a">Höhna S. 2015. The time-dependent reconstructed evolutionary process with a key-role for mass-extinction events. Journal of Theoretical Biology. 380:321–331.</span>

<a href="https://doi.org/http://dx.doi.org/10.1016/j.jtbi.2015.06.005">http://dx.doi.org/10.1016/j.jtbi.2015.06.005</a>

</li>
<li><span id="Yule1925">Yule G.U. 1925. A mathematical theory of evolution, based on the conclusions of Dr. JC Willis, FRS. Philosophical Transactions of the Royal Society of London. Series B, Containing Papers of a Biological Character. 213:21–87.</span>

</li>
<li><span id="Kendall1948">Kendall D.G. 1948. On the Generalized "Birth-and-Death" Process. The Annals of Mathematical Statistics. 19:1–15.</span>

<a href="https://doi.org/10.1214/aoms/1177730285">10.1214/aoms/1177730285</a>

</li>
<li><span id="MagnusonFord2012">Magnuson-Ford K., Otto S.P. 2012. Linking the Investigations of Character Evolution and Species Diversification. The American Naturalist. 180:225–245.</span>

<a href="https://doi.org/10.1086/666649">10.1086/666649</a>

</li>
<li><span id="Hoehna2014b">Höhna S., Heath T.A., Boussau B., Landis M.J., Ronquist F., Huelsenbeck J.P. 2014. Probabilistic Graphical Model Representation in Phylogenetics. Systematic Biology. 63:753–771.</span>

<a href="https://doi.org/10.1093/sysbio/syu039">10.1093/sysbio/syu039</a>

</li></ol>

<script type="text/javascript">
var _ol = document.querySelectorAll('ol');
for (var i = 0, elem_ol; elem_ol = _ol[i]; i++) {
	if ( elem_ol.classList == "bibliography" ) {
		var _li = elem_ol.getElementsByTagName("li");
		//for (var j = 0, elem_li; elem_li = _li[j]; j++)
		//{
		//	elem_li.innerHTML = elem_li.innerHTML.replace(/(https?:\/\/)([^\s<]+)/,"<a href=\"$1$2\">$2");
		//}
		if(_li.length > 0)
			elem_ol.outerHTML = "<h2>References</h2>"+elem_ol.outerHTML
	}
}
</script>

      <br>
<footer>
  <div class="container">
  <div class="row">
    <div class="col-sm-12" align="center">
      <a href="https://github.com/revbayes">GitHub</a> | <a href="/revbayes-site/license/">License</a> | <a href="/revbayes-site/citation/">Cite RevBayes</a> | <a href="https://groups.google.com/forum/#!forum/revbayes-users">Users Forum</a>
    </div>
  </div>
  <br>
  </div>
</footer>

    </div>
    <script src="/revbayes-site/assets/js/vendor/jquery.min.js"></script>
<script src="/revbayes-site/assets/js/vendor/FileSaver.min.js"></script>
<script src="/revbayes-site/assets/js/vendor/jszip.min.js"></script>
<script src="/revbayes-site/assets/js/vendor/bootstrap.min.js"></script>

<script type="text/javascript">
// Add default language
$(":not(code).highlighter-rouge").each(function() {
  
  if( this.classList == "highlighter-rouge") {
    this.classList = "Rev highlighter-rouge";
  }
  
});
// $("code.highlighter-rouge").each(function() {
//   
//   if( this.classList == "highlighter-rouge") {
//       this.classList = "Rev highlighter-rouge";
//   }
//   
// });
</script>

<script src="/revbayes-site/assets/js/base.js"></script>

<script type="text/javascript"
    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
  });
</script>

  </body>
</html>
