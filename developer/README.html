<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="search-domain" value="https://willpett.github.io/revbayes_tutorials/">
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    <link rel="stylesheet" href="/revbayes_tutorials/assets/css/syntax.css">
    <link rel="stylesheet" type="text/css" href="/revbayes_tutorials/assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="/revbayes_tutorials/assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="/revbayes_tutorials/assets/css/main.css" />
    <title>RevBayes: Developer</title>
  </head>
  <body>
    <div class="container">
      <nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <a href="https://revbayes.github.io" class="pull-left">
        <img class="navbar-logo" src="/revbayes_tutorials/assets/img/aquabayes-desaturated.png" alt="RevBayes Logo" />
      </a>
      
      
      <a class="navbar-brand" href="/revbayes_tutorials/">Home</a>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

	
        <li><a href="/revbayes_tutorials/software/">Software</a></li>
        <li><a href="/revbayes_tutorials/developer/">Developer</a></li>
        <li><a href="/revbayes_tutorials/tutorials/">Tutorials</a></li>
        <li><a href="/revbayes_tutorials/workshops/">Workshops</a></li>
      </ul>
      <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form>
    </div>
  </div>
</nav>

      <div class="row">
	<h1 class="maintitle">Developer</h1>
	<h3 class="subtitle"></h3>
	<h4 class="maintitle"></h4>
</div>

      
<blockquote class="overview no-print" id="overview">
  <h2>Overview</h2>
  <div class="row">
    <div class="col-md-9">
        <strong>Prerequisites</strong>
        
          <ul>
          <li>None</li>
          </ul>
        
    </div>
  </div>
</blockquote>

<blockquote class="tutorial_files no-print" id="tutorial_files">
  <h2>Data files and scripts</h2>
  
    <div class="row" id="script_row">
      <div class="col-md-9">
          <strong>Scripts</strong>
          <ul id="scripts"></ul>
        </div>
    </div>
</blockquote>
      <h1 id="revbayes-developers-manual">RevBayes Developer’s Manual</h1>

<hr />
<h2 id="table-of-contents">Table of Contents</h2>
<p><em>(See <a href="http://revbayes.github.io/about.html">website</a> for installing RevBayes)</em></p>

<ol>
  <li>Overview of RevBayes layout</li>
</ol>

<ul>
  <li>
    <p>Github general info</p>

    <ul>
      <li>
        <p>Master branch</p>
      </li>
      <li>
        <p>Development branch</p>
      </li>
    </ul>
  </li>
  <li>
    <p>General RevBayes layout info</p>

    <ul>
      <li>
        <p>levels within RevBayes</p>
      </li>
      <li>
        <p>Dag folder</p>
      </li>
      <li>
        <p>Data types</p>
      </li>
    </ul>
  </li>
</ul>

<ol>
  <li>
    <p>IDE’s: getting RevBayes locally configured</p>

    <ul>
      <li>
        <p>General info</p>
      </li>
      <li>
        <p>List of various IDE’s available</p>
      </li>
      <li>
        <p>Steps for how to properly configure RevBayes in an IDE</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Implementing a Function</p>

    <ul>
      <li>
        <p>General info about function types in RevBayes</p>
      </li>
      <li>
        <p>Creating appropriate files in the  correct directories</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Implementing a Distribution</p>

    <ul>
      <li>Creating appropriate files in the correct directories</li>
    </ul>
  </li>
  <li>
    <p>Implementing a Move</p>

    <ul>
      <li>
        <p>General info about moves directory in RevBayes</p>
      </li>
      <li>
        <p>Steps for implementing a new Move</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Building and Analyzing a new Model</p>

    <ul>
      <li>
        <p>Critical components</p>
      </li>
      <li>
        <p>Steps</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Testing suites/validation scripts</p>
  </li>
  <li>
    <p>Writing simulation scripts</p>
  </li>
</ol>

<hr />
<h2 id="1-overview-of-revbayes-layout">1. Overview of RevBayes Layout</h2>

<p><strong>The Branching Git-flow used is:</strong></p>

<p><em>Master branch</em>: always stable; releases are tagged off of this</p>

<p><em>Development branch:</em> Always branch off of this. Then merge with master, and then release from the Master branch. If you make a new branch, merge it with <em>Development</em> first &amp; then merge with <em>Master</em>.</p>

<ul>
  <li><em>Note:</em> If you don’t want to make any big merged changes but want to play around with new things, use git fork.</li>
</ul>

<p><strong>General RevBayes layout info:</strong></p>

<p>RevBayes is written in object-oriented C++. There is a heirarchy of classes, so developers will most often need to work with the ‘abstract/parent’ class. However, it’s sometimes necessary to use sub-classes. You can follow the paths to the parent class through the code to find who owns a subclass.</p>

<p>There are two main directories within RevBayes:</p>

<ul>
  <li>
    <p>revlanguage</p>
  </li>
  <li>
    <p>core</p>
  </li>
</ul>

<p><strong>.h = header files</strong> (where you define the class and reference the .cpp files).</p>

<p><strong>.cpp = C++ files</strong> (where you implement the RevBayes functionality/distributions/etc. and reference the header file code).</p>

<p>Note: Anytime you write anything new, you must add it to an “RbRegister_” file, located in /revlanguage/workspace/ (there are separate RbRegister files for adding new functions, distributions, moves, types, help documentation, etc.)</p>

<p><em>In the backend, if you write a new function/distribution you must create files for it in both the revlanguage and the core folders. Specifics on this are included in the ‘Implementing a Function’ and ‘Implementing a Distribution’</em></p>

<p><strong>Dag Folder:</strong> contains different types of stochastic nodes &amp; features necessary for graphical model components</p>

<p><strong>Data Types:</strong> These are the different object types in RevBayes. There are a lot, so it’s crucial you use  the right ones.</p>

<ul>
  <li>Examples: natural, real, probability, vectors, etc.</li>
</ul>

<hr />
<h2 id="2-ides">2. IDE’s</h2>

<p><strong>General info:</strong></p>

<ul>
  <li>
    <p><em>Examples of IDE’s</em>: XCode, Eclipse Oxygen, etc.</p>
  </li>
  <li>
    <p><strong>add info about using a standard text editor instead</strong></p>
  </li>
  <li>
    <p><strong>add info about vim…Will Freyman &amp; Emma use this</strong></p>
  </li>
  <li>
    <p>XCode does not keep track of files, so each time you open your RevBayes project in XCode you must pull revbayes-master from git &amp; remove reference to all of the source.</p>
  </li>
  <li>
    <p>Eclipse Oxygen does a cleaner job of managing the files; you do not need to pull from git each time you work in it.</p>
  </li>
</ul>

<p><strong>Creating a RevBayes project in XCode</strong></p>

<ol>
  <li>
    <p>Click on “Create a new Xcode project”</p>
  </li>
  <li>
    <p>Click on “Command Line Tool”</p>
  </li>
  <li>
    <p>Name your project (e.g. revbayes_work)</p>
  </li>
  <li>This will open up the editor window. On the left hand‑side there will be a list of files. Delete all of these, except for Products</li>
  <li>
    <p>Now go to file ‑&gt; add files to ‑&gt; navigate to where you have revbayes installed. Within the revbayes directory, find src/ and then add these three folders: core, libs, and revlanguage. Assuming your revbayes directory is version controlled using git you can now edit files in Xcode and version control from your revbayes directory.</p>
  </li>
  <li>
    <p>Now you need to change some settings. Click on the blue xcode icon on the top left hand side of your editor (it should be above some yellow folders).</p>
  </li>
  <li>
    <p>Now go to the ‘Build Settings’ tab and ensure you’re on the ‘All’ selection (rather than Basic or Customized). Then, scroll down to the “Apple LLVM [9.0] - Preprocessing” section, and under “Preprocessor macros” set the Debug value to 1 as follows: RB_XCODE=1</p>
  </li>
  <li>
    <p>Now scroll down to ‘Search Paths’ and under Debug and Release add: /Users/…/projects/revbayes/boost_1_60_0 to both</p>
  </li>
  <li>Scroll to “Apple LLVM ‑ [9.0] Language‑ C++” and change the ‘C++ language dialect’ to GNU++98 and change the ‘C++ standard library’ to libstdc++</li>
</ol>

<p><a href="eclipse-config/README.md"><strong>Creating a RevBayes project in Eclipse</strong></a></p>

<p><strong>Add in steps for setting up vim</strong></p>

<hr />
<h2 id="3-implementing-a-function">3. Implementing a Function</h2>

<p><strong>General info</strong>:
There are different types of functions in RevBayes:</p>

<ul>
  <li>
    <p>Virtual functions: within the parent class</p>
  </li>
  <li>
    <p>Member functions: do something on an object</p>
  </li>
  <li>
    <p>Typed functions”: take in an object</p>
  </li>
  <li>
    <p>Update functions: <strong>Fill in</strong></p>
  </li>
  <li>
    <p>Deterministic functions: create deterministic nodes. Must be created in the core folder.</p>
  </li>
</ul>

<p><em>Note: if we want to return a deterministic node, then we need to write a member method (example: a tree statistic).</em></p>

<p><strong>Steps</strong></p>

<ol>
  <li>Depending on the type of function you are creating, you’ll create it in one of the following categories:</li>
</ol>

<ul>
  <li>
    <p>For member functions: create a new file in /revlanguage/datatypes/</p>
  </li>
  <li>
    <p>For other functions: create a new file in revlanguage/functions/… (use appropriate subdirectory based on the nature of your function)</p>
  </li>
</ul>

<p><em>Note: If you write a void/IO function, you don’t need to put it in the core folder unless it returns core objects.</em></p>

<p><strong>Add more steps</strong></p>

<p><em>Note: Methods -&gt; functions: returns a model object with a DAG node attached (contains member functions).</em>
<em>Methods -&gt; procedures: returns a workspace object (contains method procedures)</em></p>

<p><strong>Add specific steps for editing the RbRegister file</strong></p>

<hr />
<h2 id="4-implementing-a-distribution">4. Implementing a Distribution</h2>

<p><strong>General info before getting started:</strong></p>

<p>Within RevBayes, there are math distributions and phylogenetic distributions. 
All predefined mathematical distributions that have been implemented exist in <code class="highlighter-rouge">core/distributions/math</code>.</p>

<p>Note that when implementing a new distribution, you will need to create <code class="highlighter-rouge">.cpp</code> and <code class="highlighter-rouge">.h</code> files in both the revlanguage directory and the core directory. For the language side, one of the most important things is the create distribution function (it converts user-arguments into calculations). Also, the getParameterRules function is important (to get the degrees of freedom &amp; other things). As a rule of thumb, you can look at the code of existing distributions for general help on syntax &amp; organization.</p>

<p>Within your new distribution, you will need to include some functions. For example, each new distribution must have: the get class type, name, and help. Some of these you may not need to implement (if it’s dictated by the parent class &amp; is already present), but others you will need to implement within the distribution.</p>

<p>Distributions have a prefexed DN (dag node), and all moves have a previxed MV (move). RevBayes takes the name within &amp; creates the DN automatically, so be aware of this.</p>

<p>In the following steps, we’ll implement the Beta Binomial Distribution as an example, for syntax purposes.</p>

<p><strong>Steps</strong>:</p>

<ol>
  <li>Create new .cpp &amp; .h files in <code class="highlighter-rouge">revlanguage/distributions/math/</code>  (named <code class="highlighter-rouge">Dist_betabinomial.cpp</code>, <code class="highlighter-rouge">Dist_betaBinomial.h</code>)</li>
</ol>

<p>To populate these files, look at existing examples of similar distributions for specific info on what to include &amp; on proper syntax. For example, for the Beta Binomial distribution, I looked to the existing Binomial Distribution code for guidance.</p>

<p>2.
    a.  Create new .cpp &amp; .h files in <code class="highlighter-rouge">core/distributions/math/</code>  (named <code class="highlighter-rouge">BetaBinomialDistribution.cpp</code>, <code class="highlighter-rouge">BetaBinomialDistribution.h</code>).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>*Note: This is the object oriented wrapper code, that references the functions hard-coded in step 2b.*

b. Create new .cpp and .h files in `core/math/Distributions/`  (named `DistributionBetaBinomial.cpp`, `DistributionBetaBinomial.h`). 

These are the raw procedural functions in revbayes namespace (e.g. pdf, cdf, quantile); they are not derived functions. RbStatistics is a namespace. To populate these files, look at existing examples of similar distributions to get an idea of what functions to include, what variables are needed, and the proper syntax.

*Note: This is the most time-consuming step in the entire process of implementing a new distribution.*
</code></pre></div></div>

<ol>
  <li>
    <p>Navigate to <code class="highlighter-rouge">revlanguage/workspace/RbRegister_Dist.cpp</code></p>

    <p>Every implementation you add must be registered in RevBayes. All register files are located in the <code class="highlighter-rouge">revlanguage/workspace</code> directory, and there are different files for the different implementations (<code class="highlighter-rouge">RbRegister_Func.cpp</code> is for new functions; <code class="highlighter-rouge">RbRegister_Move</code> is for new types; etc.). 
We are implementing a distribution, so we will edit the <code class="highlighter-rouge">RbRegister_Dist.cpp file</code>.</p>
  </li>
</ol>

<p>4.
    You need to have an include statement at the top of the RbRegister script, to effectively add your distribution to the RevBayes language. You also need to add code to the bottom of this file, and give it a type and a ‘new’ constructor. Generally, you can look within the file for an idea of proper syntax to use.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>For the Beta Binomial distribution, we navigate to the section in the file with the header 'Distributions' and then look for the sub-header dealing with math distributions. Then, add the following line of code:
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include "Dist_betaBinomial.h"
</code></pre></div></div>

<p><em>This step registers the header file for the beta binomial distribution, effectively adding it to RevBayes.</em></p>

<p>Next, navigate to the section of the file that initializes the global workspace. This section defines the workspace class, which houses info on all distributions. Then, add the following line of code:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    AddDistribution&lt; Natural		&gt;( new Dist_betaBinomial());
</code></pre></div></div>

<p><em>This adds the distribution to the workspace. Without this step, the betaBinomial will not be added to the revlanguage.</em>
    <em>Note: Depending on the type of distribution, you may need to change ‘Natural’ to a different type (e.g. ‘Probability’, ‘Real’, ‘RealPos’, etc.).</em></p>

<ol>
  <li>
    <p>Before pushing your changes, you should ensure your code is working properly.</p>

    <p>There are multiple ways to do this, so use your best judgment. As a best practice, you should first compile it to ensure there are no errors. Once it compiles, you can test it various ways (e.g. run your individual functions within the new Beta Binomial distribution in R, then run the Binomial distribution with a Beta prior in Rev and see if the output matches).</p>
  </li>
</ol>

<h2 id="5-implementing-a-move">5. Implementing a Move</h2>

<p><strong>General info:</strong> Within the moves directory, efficiency can be greatly improved. But, it is not straightforward, and it’s a pain to debug.</p>

<p>It’s important to think about what types of moves are required to work on different types of objects.</p>

<p><strong>Fill in</strong></p>

<hr />
<h2 id="6-building--analyzing-a-new-model">6. Building &amp; Analyzing a new model</h2>

<p><strong>Critical components:</strong></p>

<ul>
  <li>Distributions, Functions, and Moves</li>
</ul>

<p>These are needed to work on components of any new model.</p>

<p><em>Note</em>: All predefined mathematical distributions exist in core/distributions/math</p>

<hr />
<h2 id="7-testing-suitesvalidation-scripts">7. Testing Suites/validation scripts</h2>

<p><strong>General info</strong>:</p>

<p>It’s tricky to test things in RevBayes unless you have a lot of things to test. So, sometimes you may want to write Rev code to “test” your new implementations in a hack-y way. If it’s working the way you want/expect, it will most likely compile successfully.</p>

<hr />
<h2 id="8-writing-simulation-scripts">8. Writing simulation scripts</h2>

<hr />

      <ol class="bibliography"></ol>

<script type="text/javascript">
var _ol = document.querySelectorAll('ol');
for (var i = 0, elem_ol; elem_ol = _ol[i]; i++) {
	if ( elem_ol.classList == "bibliography" ) {
		var _li = elem_ol.getElementsByTagName("li");
		//for (var j = 0, elem_li; elem_li = _li[j]; j++)
		//{
		//	elem_li.innerHTML = elem_li.innerHTML.replace(/(https?:\/\/)([^\s<]+)/,"<a href=\"$1$2\">$2");
		//}
		if(_li.length > 0)
			elem_ol.outerHTML = "<h2>References</h2>"+elem_ol.outerHTML
	}
}
</script>
      <br>
<footer>
  <div class="container">
  <div class="row">
    <div class="col-sm-12" align="center">
      <a href="https://github.com/revbayes">GitHub</a> | <a href="/revbayes_tutorials/license">License</a> | <a href="/revbayes_tutorials/citation">Cite RevBayes</a> | <a href="https://groups.google.com/forum/#!forum/revbayes-users">Users' Forum</a>
    </div>
  </div>
  </div>
</footer>

    </div>
    <script src="/revbayes_tutorials/assets/js/vendor/jquery.min.js"></script>
<script src="/revbayes_tutorials/assets/js/vendor/FileSaver.min.js"></script>
<script src="/revbayes_tutorials/assets/js/vendor/jszip.min.js"></script>
<script src="/revbayes_tutorials/assets/js/vendor/bootstrap.min.js"></script>

<script type="text/javascript">
// Add default language
$(":not(code).highlighter-rouge").each(function() {
  
  if( this.classList == "highlighter-rouge") {
    this.classList = "cpp highlighter-rouge";
  }
  
});
// $("code.highlighter-rouge").each(function() {
//   
//   if( this.classList == "highlighter-rouge") {
//       this.classList = "cpp highlighter-rouge";
//   }
//   
// });
</script>

<script src="/revbayes_tutorials/assets/js/base.js"></script>

<script type="text/javascript"
    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
  });
</script>

  </body>
</html>
